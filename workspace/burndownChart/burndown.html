<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Burndown Chart</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
	<style>
		html, body {
			margin: 0;
			padding: 0
		}

		body {
			background-color: #ebebeb;
		}

	</style>
</head>
<body>
	<script type="module">

	const height = 500
	const width = 1000
	const svg = d3.select("body")
		.append("svg")
		.attr("width", "100%")
		.attr("height", "100%")
		.attr("viewBox", `0, 0, ${width}, ${height}`)
		.attr("preserveAspectRatio", "none")

	const statusMap = await d3.tsv("./steps.tsv")
	const statusLookup = d3.index(statusMap, d => d.label)
	const rawData = await d3.tsv("./burndownData.csv")

	const dimTable = d3.group(rawData.map(audit => {
		const facts = { ... audit }
		delete facts.workstep
		delete facts.doneAt
		delete facts.doneBy
		delete facts.furtherSpecification
		delete facts.duration
		return facts
	}), d => d.auditId)

	const worklog = d3.groups(rawData.map(audit => {
		return {
			id: audit.auditId,
			workstep: statusLookup.get(audit.workstep),
			doneAt: audit.doneAt,
			doneBy: audit.doneBy,
			furtherSpecification: audit.furtherSpecification,
			duration: audit.duration
		}
	}), d => d.id)

	console.log(worklog)

	const progressionData = worklog.map(logPerID => {
		const [id, logs] = logPerID
		const processLogs = (logs) => {
			let currentStatus = 0
			const returnArray = logs.map(log => {
				const returnObj = [
					{ id, date: log.doneAt, statusId: currentStatus, value: -1 },
					{ id, date: log.doneAt, statusId: Number(log.workstep.ID), value: 1 }
				 ]
				 currentStatus = Number(log.workstep.ID)
				return returnObj
			})
			return returnArray.flat()
		}

		return processLogs(logs)
	})

	console.log(progressionData)

	const margin = { left: 50, top: 10, bottom: 50, right: 10 }
	const canvas = svg
		.append("g")
		.attr("class", "canvas")
		.attr("fill", "yellow")
		.attr("transform", `translate(${margin.left}, ${margin.top})`)

	const axes = svg.append("g").attr("class", "axes")

	const xScale = d3.scaleTime()
		.domain(d3.extent(rawData, d => new Date(d.doneAt)))
		.range([0, width - margin.left - margin.right])

	const groupByAuditId = d3.groups(rawData, d => d.auditId)

	const yScale = d3.scaleLinear()
		.domain([0, groupByAuditId.length])
		.range([height - margin.bottom, 0])

	yScale

	axes
		.append("g")
		.attr("class", "x axis")
		.attr("transform", `translate(${margin.left}, ${height - margin.bottom})`)
		.call(d3.axisBottom(xScale))

	axes
		.append("g")
		.attr("class", "y axis")
		.attr("transform", `translate(${margin.left}, ${margin.top})`)
		.call(d3.axisLeft(yScale))

	</script>
</body>
</html>
