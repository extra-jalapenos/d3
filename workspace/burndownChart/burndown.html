<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Burndown Chart</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
	<style>
		html, body {
			margin: 0;
			padding: 0
		}

		body {
			background-color: #ebebeb;
		}

	</style>
</head>
<body>
	<script type="module">

	const height = 500
	const width = 1000
	const svg = d3.select("body")
		.append("svg")
		.attr("width", "100%")
		.attr("height", "100%")
		.attr("viewBox", `0, 0, ${width}, ${height}`)
		.attr("preserveAspectRatio", "none")

	const statusMap = await d3.tsv("./steps.tsv")
	const statusLookup = d3.index(statusMap, d => d.stepName)
	const rawData = await d3.tsv("./burndownData.csv")
	const distinctDates = d3.union(rawData.map(d => new Date(d.doneAt)))
	const distinctStatus = statusMap.map(status => String(status.id))
	const fillerDates = distinctDates.keys().map(date => {
		return distinctStatus.map(status => {
			return { date, status: { id: status }, value: 0 }
		})
	})

	const refYear = Number(d3.mode(rawData, d => d.referenceYear))

	const dimTable = d3.group(rawData.map(audit => {
		const facts = { ... audit }
		delete facts.workstep
		delete facts.doneAt
		delete facts.doneBy
		delete facts.furtherSpecification
		delete facts.duration
		return facts
	}), d => d.auditId)

	const minDate = d3.min(rawData, d => new Date(d.doneAt))

	const worklog = d3.groups(rawData.filter(audit => audit.doneAt).map(audit => {
		const [day, month, year] = audit.doneAt.split(".")
		const workstep = statusLookup.get(audit.workstep)
		if (workstep === undefined) throw Error("undefined workstep " + audit.workstep)
		return {
			id: audit.auditId,
			workstep,
			doneAt: new Date(Number(year), Number(month) - 1, Number(day)),
			doneBy: audit.doneBy,
			furtherSpecification: audit.furtherSpecification,
			duration: audit.duration
		}
	}), d => d.id)


	const progressionData = worklog.map(logPerID => {
		const [id, logs] = logPerID
		// if it's only Beginn return blank array, we'll add the +1 Beginn status later

		const processLogs = (logs) => {
			if (logs.length === 1) return []
			let currentStatus = statusLookup.get("Beginn")
			const returnArray = logs.map(log => {
				const returnObj = [
					{ id, date: log.doneAt, status: currentStatus, value: -1 },
					{ id, date: log.doneAt, status: log.workstep, value: 1 }
				 ]
				 currentStatus = log.workstep
				return returnObj
			})

			const flattened = returnArray.flat()
			return flattened
		}

		const processedLogs = processLogs(logs)
		return [...processedLogs,
			{ id, date: minDate, status: statusLookup.get("Beginn"), value: 1 }]
	})

	const valueChange = d3.rollup([
		...progressionData.flat(),
		...Array.from(fillerDates).flat(),
	], D => d3.sum(D.map(d=>d.value)), d => d.date, d => d.status.id)

	console.log(progressionData.flat()[0])
	const margin = { left: 50, top: 10, bottom: 50, right: 10 }
	const canvas = svg
		.append("g")
		.attr("class", "canvas")
		.attr("transform", `translate(${margin.left}, ${margin.top})`)

	const axes = svg.append("g").attr("class", "axes")

	const xScale = d3.scaleTime()
		.domain([new Date(refYear, 0, 1), new Date(refYear + 1, 5, 30)])
		.range([0, width - margin.left - margin.right])

	xScale.clamp(true)

	const yScale = d3.scaleLinear()
		.domain([0, 3000])
		.range([height - margin.bottom, 0])


	axes
		.append("g")
		.attr("class", "x axis")
		.attr("transform", `translate(${margin.left}, ${height + margin.top - margin.bottom})`)
		.call(d3.axisBottom(xScale))

	axes
		.append("g")
		.attr("class", "y axis")
		.attr("transform", `translate(${margin.left}, ${margin.top})`)
		.call(d3.axisLeft(yScale))

	const colorScale = d3.scaleOrdinal([
		...d3.schemeGreys[4],
		"green",
		...d3.schemeBlues[4],
		"rebeccapurple",
		"black",
		...d3.schemeOranges[4]
	])

	const areaGenerator = d3.area(d => xScale(d.date),
		d => yScale(0),
		d => yScale(d.value)).curve(d3.curveStep)
		.defined(d => d.date)

	const plots = canvas.selectAll("path").data()
			.enter()
			.append("path")
			.attr("class", "plot")
			.attr("id", (d, i) => i)
			.attr("fill", (d, i) => colorScale(i))
			.attr("opacity", 1)
			.attr("stroke", (d, i) => colorScale(i))
			.attr("d", d => areaGenerator(d[1]))
	</script>
</body>
</html>
